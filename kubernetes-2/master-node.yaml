---
- name: master instaall kubeadm 
  hosts: 3.14.149.54
  become: yes  
  tasks:
  - name: update apt repo & cache
    apt: update_cache=yes force_apt_get=yes cache_valid_time=3600 upgrade=dist
  - name: making some alias
    ansible.builtin.blockinfile:
      path: /etc/bash.bashrc
      block: |
        alias c=clear
        alias k=kubectl    
  - name: Set a hostname
    ansible.builtin.hostname:
      name: master
  - name: configure /etc/hosts file
    ansible.builtin.blockinfile:
      path: /etc/hosts
      block: |
        10.0.1.223     master
        10.0.1.252    worker1
        10.0.1.143    worker2

- name: master_install_kubeadm 
  hosts: 3.14.149.54
  become: yes
  become_user: root
  gather_facts: no   
  tasks:
  # - name: Copy install-containerd.sh file 
  #   copy:
  #     src: /home/ahmed/Desktop/terraform/kubernetes-cluster/kubernetes/install-containerd.sh
  #     dest: /home/ubuntu/install-containerd.sh
  #     mode: +x
  # - name: Copy install-kubeadm.sh file
  #   copy:
  #     src: /home/ahmed/Desktop/terraform/kubernetes-cluster/kubernetes/install-kubeadm.sh
  #     dest: /home/ubuntu/install-kubeadm.sh
  #     mode: +x
  # - name: run script install-containerd.sh
  #   ansible.builtin.command: 
  #     cmd:  /home/ubuntu/install-containerd.sh
  # - name: run script install-kubeadm.sh
  #   ansible.builtin.command: 
  #     cmd:  /home/ubuntu/install-kubeadm.sh    
  - name: update apt repo & cache
    apt: update_cache=yes force_apt_get=yes cache_valid_time=0 upgrade=dist
  - name: Install a list of packages
    ansible.builtin.apt:
      pkg:
      - apt-transport-https
      - ca-certificates
      - curl
  - name: disable swap
    ansible.builtin.command:
      cmd:  swapoff -a
  - name: configure k8s prerequists
    ansible.builtin.lineinfile:
      path: /etc/modules-load.d/k8s.conf
      line: "{{ item }}"
      create: yes      
    loop: 
    - overlay
    - br_netfilter
    register: k8s_prerequists_state

  # - name: configurer k8s prerequists
  #   ansible.builtin.blockinfile:
  #     path: /etc/modules-load.d/k8s.conf
  #     block: |
  #       overlay
  #       br_netfilter
  #     create: true

  - name: k8s prerequists continue
    ansible.builtin.command:
      cmd: sudo modprobe overlay
    when: k8s_prerequists_state.changed == true
  - name: k8s prerequists continue
    ansible.builtin.command:
      cmd: sudo modprobe br_netfilter  
    when: k8s_prerequists_state.changed == true            

  - name: configure file /etc/sysctl.d/k8s.conf
    ansible.builtin.lineinfile:
      path: /etc/sysctl.d/k8s.conf
      line: "{{ item }}"
      create: yes      
    loop: 
    - net.bridge.bridge-nf-call-iptables  = 1
    - net.bridge.bridge-nf-call-ip6tables = 1
    - net.ipv4.ip_forward                 = 1
    register: sysctl_file_state
    # notify: 
    # - reload sysctl
  # - name: configure file /etc/sysctl.d/k8s.conf
  #   ansible.builtin.blockinfile:
  #     path: /etc/sysctl.d/k8s.conf
  #     block: |
  #       net.bridge.bridge-nf-call-iptables  = 1
  #       net.bridge.bridge-nf-call-ip6tables = 1
  #       net.ipv4.ip_forward                 = 1
  #     create: true
  #     marker: no

  - name: reload sysctl
    ansible.builtin.command:
      cmd:  sysctl --system
    when: sysctl_file_state.changed == true

  - name: Install containerd
    ansible.builtin.apt:
      pkg:
      - containerd
      update_cache: yes
  - name: start & enable containerd.service
    systemd:
      name: containerd
      state: started
      enabled: true           
  - name: configure containerd config file
    ansible.builtin.command:
      cmd: containerd config default 
#      cmd: containerd config default > /etc/containerd/config.toml  #there is no redirection man
    register: cmd_result
  # - debug:
  #     msg: "this is the out of cmd_result register: {{ cmd_result }}"
  - name: configure file /etc/containerd/config.toml
    ansible.builtin.blockinfile:
      path: /etc/containerd/config.toml
      block: |
        {{ cmd_result.stdout }}
      create: true      
    when: k8s_prerequists_state.changed == true      
    # notify:
    # - restart containerd  

  # - name: configure containerd config file
  #   ansible.builtin.command:
  #     cmd: sudo sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
  - name: configure containerd config file 
    lineinfile: 
      path: /etc/containerd/config.toml
      regexp: '^            SystemdCgroup = '
      line: '            SystemdCgroup = true'
    when: k8s_prerequists_state.changed == true      
    # notify:
    # - restart containerd  

  - name: removing ansible marker from /etc/containerd/config.toml
    ansible.builtin.lineinfile:
      path: /etc/containerd/config.toml
      state: absent
      regexp: 'ANSIBLE'
    when: k8s_prerequists_state.changed == true

  - name: restart containerd
    systemd:
      name: containerd
      state: restarted      
    when: k8s_prerequists_state.changed == true

  - name: Check if file /etc/apt/keyrings/kubernetes-apt-keyring.gpg exists
    stat:
      path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    register: stat_result
  - debug:
      var: stat_result.stat.exists
  - name: Add k8s key
    ansible.builtin.shell: curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    when: not stat_result.stat.exists
  # - name: add k8s repo
  #   ansible.builtin.command:
  #     cmd: echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
  - name: configure file /etc/apt/sources.list.d/kubernetes.list
    ansible.builtin.blockinfile:
      path: /etc/apt/sources.list.d/kubernetes.list
      block: |
        deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /
      create: true


  - name: Check if file /etc/kubernetes/admin.conf exists
    stat:
      path: /etc/kubernetes/admin.conf 
    register: stat_kube_init_result
  - debug:
      var: stat_kube_init_result.stat.exists

  - name: update apt repo & cache
    apt:
      update_cache: yes
  - name: Install kubeadm
    ansible.builtin.apt:
      update_cache: yes
      pkg:
        - kubelet=1.28.2-1.1
        - kubeadm=1.28.2-1.1
        - kubectl=1.28.2-1.1
      allow_downgrade: true

  - name: kubeadm init
    become: yes
    become_user: root
    ansible.builtin.command: 
      cmd: kubeadm init
    when: not stat_kube_init_result.stat.exists    

  - name: Create /home/ubuntu/.kube directory if it does not exist
    ansible.builtin.file:
      path: /home/ubuntu/.kube
      state: directory
  - name: Copy kubeconfig file 
    become: yes
    become_user: root
    copy:
      src: /etc/kubernetes/admin.conf 
      dest: /home/ubuntu/.kube/config
      remote_src: true
  - name: change ownership of kubeconfig file
    ansible.builtin.file:      
      path: /home/ubuntu/.kube/config
      state: file
      owner: ubuntu
      group: ubuntu            
  - name: generate token for worker1 to join
    ansible.builtin.command: 
      cmd: kubeadm token create --print-join-command
    register: kubeadm_command_output
  - name: output the register variable value
    debug:
      msg: 
      - "the kubeadm_command_output.stdout register =  {{kubeadm_command_output.stdout}}"
  - name: output the register variable value by hosts
    debug:
      var:  hostvars['3.14.149.54.kubeadm_command_output.stdout']
  - name: output the register variable value by play name
    debug:
      var:  hostvars['master_instaall_kubeadm']['kubeadm_command_output.stdout']
  - name: deploy weave cni
    become: yes
    become_user: ubuntu
    ansible.builtin.command: 
      cmd: kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml
    changed_when: false
  # handlers:
  # - name: reload sysctl
  #   ansible.builtin.command:
  #     cmd:  sysctl --system
  # - name: restart containerd
  #   systemd:
  #     name: containerd
  #     state: restarted      


- name: worker1 instaall kubeadm 
  hosts: 18.221.38.211
  become: yes  
  tasks:
  - name: play-1-task-1 update apt repo & cache
    apt: update_cache=yes force_apt_get=yes cache_valid_time=3600 upgrade=dist
  - name: making some alias
    ansible.builtin.blockinfile:
      path: /etc/bash.bashrc
      block: |
        alias c=clear
        alias k=kubectl    
  - name: Set a hostname
    ansible.builtin.hostname:
      name: worker1
  - name: making some alias
    ansible.builtin.blockinfile:
      path: /etc/hosts
      block: |
        10.0.1.223     master
        10.0.1.252    worker1
        10.0.1.143    worker2

- name: instaall kubeadm 
  hosts: 18.221.38.211    
  become: yes
  become_user: root      
  tasks:
  # - name: Copy install-containerd.sh file 
  #   copy:
  #     src: /home/ahmed/Desktop/terraform/kubernetes-cluster/kubernetes/install-containerd.sh
  #     dest: /home/ubuntu/install-containerd.sh
  #     mode: +x
  # - name: Copy install-kubeadm.sh file
  #   copy:
  #     src: /home/ahmed/Desktop/terraform/kubernetes-cluster/kubernetes/install-kubeadm.sh
  #     dest: /home/ubuntu/install-kubeadm.sh
  #     mode: +x
  # - name: run script install-containerd.sh
  #   ansible.builtin.command: 
  #     cmd:  /home/ubuntu/install-containerd.sh
  # - name: run script install-kubeadm.sh
  #   ansible.builtin.command: 
  #     cmd:  /home/ubuntu/install-kubeadm.sh

  # - name: play-1update apt repo & cache
  #   apt: update_cache=yes force_apt_get=yes cache_valid_time=0 upgrade=dist
  # - name: Install a list of packages
  #   ansible.builtin.apt:
  #     pkg:
  #     - apt-transport-https
  #     - ca-certificates
  #     - curl
  # - name: disable swap
  #   ansible.builtin.command:
  #     cmd:  swapoff -a
  # - name: configurer k8s prerequists
  #   ansible.builtin.blockinfile:
  #     path: /etc/modules-load.d/k8s.conf
  #     block: |
  #       overlay
  #       br_netfilter
  #     create: true
  # - name: k8s prerequists continue
  #   ansible.builtin.command:
  #     cmd: sudo modprobe overlay
  # - name: k8s prerequists continue
  #   ansible.builtin.command:
  #     cmd: sudo modprobe br_netfilter        
  # - name: configure file /etc/sysctl.d/k8s.conf
  #   ansible.builtin.blockinfile:
  #     path: /etc/sysctl.d/k8s.conf
  #     block: |
  #       net.bridge.bridge-nf-call-iptables  = 1
  #       net.bridge.bridge-nf-call-ip6tables = 1
  #       net.ipv4.ip_forward                 = 1
  #     create: true
  #     marker: no
  # - name: reload sysctl
  #   ansible.builtin.command:
  #     cmd:  sysctl --system
  # - name: Install containerd
  #   ansible.builtin.apt:
  #     pkg:
  #     - containerd
  #     update_cache: yes
  # - name: start & enable containerd.service
  #   systemd:
  #     name: containerd
  #     state: started
  # - name: configure containerd config file
  #   ansible.builtin.command:
  #     cmd: containerd config default > /etc/containerd/config.toml
  #   register: cmd_result
  # - debug:
  #     msg: "this is the out of cmd_result register: {{ cmd_result }}"
  # - name: configure file /etc/containerd/config.toml
  #   ansible.builtin.blockinfile:
  #     path: /etc/containerd/config.toml
  #     block: |
  #       {{ cmd_result.stdout }}
  #     create: true      
  # - name: configure containerd config file
  #   ansible.builtin.command:
  #     cmd: sudo sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
  # - name: restart containerd.service
  #   systemd:
  #     name: containerd
  #     state: restarted      
  # - name: Check if file /etc/apt/keyrings/kubernetes-apt-keyring.gpg exists
  #   stat:
  #     path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  #   register: stat_result
  # - debug: msg={{stat_result}}
  # - name: Execute the command in remote shell; stdout goes to the specified file on the remote
  #   ansible.builtin.shell: curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  #   when: not stat_result.stat.exists
  # # - name: add k8s repo
  # #   ansible.builtin.command:
  # #     cmd: echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
  # - name: configure file /etc/apt/sources.list.d/kubernetes.list
  #   ansible.builtin.blockinfile:
  #     path: /etc/apt/sources.list.d/kubernetes.list
  #     block: |
  #       deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /
  #     create: true
  # - name: update apt repo & cache
  #   apt:
  #     update_cache: yes
  # - name: Install kubeadm
  #   ansible.builtin.apt:
  #     update_cache: yes
  #     pkg:
  #       - kubelet=1.28.2-1.1
  #       - kubeadm=1.28.2-1.1
  #       - kubectl=1.28.2-1.1
  #     allow_downgrade: true

  - name: update apt repo & cache
    apt: update_cache=yes force_apt_get=yes cache_valid_time=0 upgrade=dist
  - name: Install a list of packages
    ansible.builtin.apt:
      pkg:
      - apt-transport-https
      - ca-certificates
      - curl
  - name: disable swap
    ansible.builtin.command:
      cmd:  swapoff -a
  - name: configure k8s prerequists
    ansible.builtin.lineinfile:
      path: /etc/modules-load.d/k8s.conf
      line: "{{ item }}"
      create: yes      
    loop: 
    - overlay
    - br_netfilter
    register: k8s_prerequists_state

  # - name: configurer k8s prerequists
  #   ansible.builtin.blockinfile:
  #     path: /etc/modules-load.d/k8s.conf
  #     block: |
  #       overlay
  #       br_netfilter
  #     create: true

  - name: k8s prerequists continue
    ansible.builtin.command:
      cmd: sudo modprobe overlay
    when: k8s_prerequists_state.changed == true
  - name: k8s prerequists continue
    ansible.builtin.command:
      cmd: sudo modprobe br_netfilter  
    when: k8s_prerequists_state.changed == true            

  - name: configure file /etc/sysctl.d/k8s.conf
    ansible.builtin.lineinfile:
      path: /etc/sysctl.d/k8s.conf
      line: "{{ item }}"
      create: yes      
    loop: 
    - net.bridge.bridge-nf-call-iptables  = 1
    - net.bridge.bridge-nf-call-ip6tables = 1
    - net.ipv4.ip_forward                 = 1
    register: sysctl_file_state
    # notify: 
    # - reload sysctl
  # - name: configure file /etc/sysctl.d/k8s.conf
  #   ansible.builtin.blockinfile:
  #     path: /etc/sysctl.d/k8s.conf
  #     block: |
  #       net.bridge.bridge-nf-call-iptables  = 1
  #       net.bridge.bridge-nf-call-ip6tables = 1
  #       net.ipv4.ip_forward                 = 1
  #     create: true
  #     marker: no

  - name: reload sysctl
    ansible.builtin.command:
      cmd:  sysctl --system
    when: sysctl_file_state.changed == true

  - name: Install containerd
    ansible.builtin.apt:
      pkg:
      - containerd
      update_cache: yes
  - name: start & enable containerd.service
    systemd:
      name: containerd
      state: started
      enabled: true           
  - name: configure containerd config file
    ansible.builtin.command:
      cmd: containerd config default 
#      cmd: containerd config default > /etc/containerd/config.toml  #there is no redirection man
    register: cmd_result
  # - debug:
  #     msg: "this is the out of cmd_result register: {{ cmd_result }}"
  - name: configure file /etc/containerd/config.toml
    ansible.builtin.blockinfile:
      path: /etc/containerd/config.toml
      block: |
        {{ cmd_result.stdout }}
      create: true      
    when: k8s_prerequists_state.changed == true      
    # notify:
    # - restart containerd  

  # - name: configure containerd config file
  #   ansible.builtin.command:
  #     cmd: sudo sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
  - name: configure containerd config file 
    lineinfile: 
      path: /etc/containerd/config.toml
      regexp: '^            SystemdCgroup = '
      line: '            SystemdCgroup = true'
    when: k8s_prerequists_state.changed == true      
    # notify:
    # - restart containerd  

  - name: removing ansible marker from /etc/containerd/config.toml
    ansible.builtin.lineinfile:
      path: /etc/containerd/config.toml
      state: absent
      regexp: 'ANSIBLE'
    when: k8s_prerequists_state.changed == true

  - name: restart containerd
    systemd:
      name: containerd
      state: restarted      
    when: k8s_prerequists_state.changed == true

  - name: Check if file /etc/apt/keyrings/kubernetes-apt-keyring.gpg exists
    stat:
      path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    register: stat_result
  - debug: msg={{stat_result}}
  - name: Add k8s key
    ansible.builtin.shell: curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    when: not stat_result.stat.exists
  # - name: add k8s repo
  #   ansible.builtin.command:
  #     cmd: echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
  - name: configure file /etc/apt/sources.list.d/kubernetes.list
    ansible.builtin.blockinfile:
      path: /etc/apt/sources.list.d/kubernetes.list
      block: |
        deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /
      create: true

  - name: Check if file /etc/kubernetes/admin.conf exists
    stat:
      path: /etc/kubernetes/admin.conf 
    register: stat_kube_init_result
  - debug: msg={{stat_kube_init_result}}

  - name: update apt repo & cache
    apt:
      update_cache: yes
  - name: Install kubeadm
    ansible.builtin.apt:
      update_cache: yes
      pkg:
        - kubelet=1.28.2-1.1
        - kubeadm=1.28.2-1.1
        - kubectl=1.28.2-1.1
      allow_downgrade: true


  - name: output the register variable value
    debug:
      var:  hostvars['3.14.149.54']['kubeadm_command_output']['stdout']      
  - name: output the register variable value
    debug:
      var:  hostvars['master_instaall_kubeadm']['kubeadm_command_output']['stdout']
  - name: kubeadm join 
    ansible.builtin.command: 
      cmd: "{{ hostvars['3.14.149.54']['kubeadm_command_output']['stdout'] }}"      
    when: k8s_prerequists_state.changed == true                        



- name: worker2 instaall kubeadm 
  hosts: 18.118.168.58
  become: yes  
  tasks:
  - name: update apt repo & cache
    apt: update_cache=yes force_apt_get=yes cache_valid_time=3600 upgrade=dist
  - name: making some alias
    ansible.builtin.blockinfile:
      path: /etc/bash.bashrc
      block: |
        alias c=clear
        alias k=kubectl    
  - name: Set a hostname
    ansible.builtin.hostname:
      name: worker2
  - name: making some alias
    ansible.builtin.blockinfile:
      path: /etc/hosts
      block: |
        10.0.1.223     master
        10.0.1.252    worker1
        10.0.1.143    worker2

- name: instaall kubeadm 
  hosts: 18.118.168.58    
  become: yes
  become_user: root      
  tasks:
  # - name: Copy install-containerd.sh file 
  #   copy:
  #     src: /home/ahmed/Desktop/terraform/kubernetes-cluster/kubernetes/install-containerd.sh
  #     dest: /home/ubuntu/install-containerd.sh
  #     mode: +x
  # - name: Copy install-kubeadm.sh file
  #   copy:
  #     src: /home/ahmed/Desktop/terraform/kubernetes-cluster/kubernetes/install-kubeadm.sh
  #     dest: /home/ubuntu/install-kubeadm.sh
  #     mode: +x
  # - name: run script install-containerd.sh
  #   ansible.builtin.command: 
  #     cmd:  /home/ubuntu/install-containerd.sh
  # - name: run script install-kubeadm.sh
  #   ansible.builtin.command: 
  #     cmd:  /home/ubuntu/install-kubeadm.sh

  # - name: play-1update apt repo & cache
  #   apt: update_cache=yes force_apt_get=yes cache_valid_time=0 upgrade=dist
  # - name: Install a list of packages
  #   ansible.builtin.apt:
  #     pkg:
  #     - apt-transport-https
  #     - ca-certificates
  #     - curl
  # - name: disable swap
  #   ansible.builtin.command:
  #     cmd:  swapoff -a
  # - name: configurer k8s prerequists
  #   ansible.builtin.blockinfile:
  #     path: /etc/modules-load.d/k8s.conf
  #     block: |
  #       overlay
  #       br_netfilter
  #     create: true
  # - name: k8s prerequists continue
  #   ansible.builtin.command:
  #     cmd: sudo modprobe overlay
  # - name: k8s prerequists continue
  #   ansible.builtin.command:
  #     cmd: sudo modprobe br_netfilter        
  # - name: configure file /etc/sysctl.d/k8s.conf
  #   ansible.builtin.blockinfile:
  #     path: /etc/sysctl.d/k8s.conf
  #     block: |
  #       net.bridge.bridge-nf-call-iptables  = 1
  #       net.bridge.bridge-nf-call-ip6tables = 1
  #       net.ipv4.ip_forward                 = 1
  #     create: true
  #     marker: no
  # - name: reload sysctl
  #   ansible.builtin.command:
  #     cmd:  sysctl --system
  # - name: Install containerd
  #   ansible.builtin.apt:
  #     pkg:
  #     - containerd
  #     update_cache: yes
  # - name: start & enable containerd.service
  #   systemd:
  #     name: containerd
  #     state: started
  # - name: configure containerd config file
  #   ansible.builtin.command:
  #     cmd: containerd config default > /etc/containerd/config.toml
  #   register: cmd_result
  # - debug:
  #     msg: "this is the out of cmd_result register: {{ cmd_result }}"
  # - name: configure file /etc/containerd/config.toml
  #   ansible.builtin.blockinfile:
  #     path: /etc/containerd/config.toml
  #     block: |
  #       {{ cmd_result.stdout }}
  #     create: true      
  # - name: configure containerd config file
  #   ansible.builtin.command:
  #     cmd: sudo sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
  # - name: restart containerd.service
  #   systemd:
  #     name: containerd
  #     state: restarted      
  # - name: Check if file /etc/apt/keyrings/kubernetes-apt-keyring.gpg exists
  #   stat:
  #     path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  #   register: stat_result
  # - debug: msg={{stat_result}}
  # - name: Execute the command in remote shell; stdout goes to the specified file on the remote
  #   ansible.builtin.shell: curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  #   when: not stat_result.stat.exists
  # # - name: add k8s repo
  # #   ansible.builtin.command:
  # #     cmd: echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
  # - name: configure file /etc/apt/sources.list.d/kubernetes.list
  #   ansible.builtin.blockinfile:
  #     path: /etc/apt/sources.list.d/kubernetes.list
  #     block: |
  #       deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /
  #     create: true
  # - name: update apt repo & cache
  #   apt:
  #     update_cache: yes
  # - name: Install kubeadm
  #   ansible.builtin.apt:
  #     update_cache: yes
  #     pkg:
  #       - kubelet=1.28.2-1.1
  #       - kubeadm=1.28.2-1.1
  #       - kubectl=1.28.2-1.1
  #     allow_downgrade: true

  # - name: output the register variable value
  #   debug:
  #     var:  hostvars['3.14.149.54']['kubeadm_command_output']['stdout']      
  # - name: output the register variable value
  #   debug:
  #     var:  hostvars['master_instaall_kubeadm']['kubeadm_command_output']['stdout']
  # - name: kubeadm join 
  #   ansible.builtin.command: 
  #     cmd: "{{ hostvars['3.14.149.54']['kubeadm_command_output']['stdout'] }}"      




  - name: update apt repo & cache
    apt: update_cache=yes force_apt_get=yes cache_valid_time=0 upgrade=dist
  - name: Install a list of packages
    ansible.builtin.apt:
      pkg:
      - apt-transport-https
      - ca-certificates
      - curl
  - name: disable swap
    ansible.builtin.command:
      cmd:  swapoff -a
  - name: configure k8s prerequists
    ansible.builtin.lineinfile:
      path: /etc/modules-load.d/k8s.conf
      line: "{{ item }}"
      create: yes      
    loop: 
    - overlay
    - br_netfilter
    register: k8s_prerequists_state

  # - name: configurer k8s prerequists
  #   ansible.builtin.blockinfile:
  #     path: /etc/modules-load.d/k8s.conf
  #     block: |
  #       overlay
  #       br_netfilter
  #     create: true

  - name: k8s prerequists continue
    ansible.builtin.command:
      cmd: sudo modprobe overlay
    when: k8s_prerequists_state.changed == true
  - name: k8s prerequists continue
    ansible.builtin.command:
      cmd: sudo modprobe br_netfilter  
    when: k8s_prerequists_state.changed == true            

  - name: configure file /etc/sysctl.d/k8s.conf
    ansible.builtin.lineinfile:
      path: /etc/sysctl.d/k8s.conf
      line: "{{ item }}"
      create: yes      
    loop: 
    - net.bridge.bridge-nf-call-iptables  = 1
    - net.bridge.bridge-nf-call-ip6tables = 1
    - net.ipv4.ip_forward                 = 1
    register: sysctl_file_state
    # notify: 
    # - reload sysctl
  # - name: configure file /etc/sysctl.d/k8s.conf
  #   ansible.builtin.blockinfile:
  #     path: /etc/sysctl.d/k8s.conf
  #     block: |
  #       net.bridge.bridge-nf-call-iptables  = 1
  #       net.bridge.bridge-nf-call-ip6tables = 1
  #       net.ipv4.ip_forward                 = 1
  #     create: true
  #     marker: no

  - name: reload sysctl
    ansible.builtin.command:
      cmd:  sysctl --system
    when: sysctl_file_state.changed == true

  - name: Install containerd
    ansible.builtin.apt:
      pkg:
      - containerd
      update_cache: yes
  - name: start & enable containerd.service
    systemd:
      name: containerd
      state: started
      enabled: true           
  - name: configure containerd config file
    ansible.builtin.command:
      cmd: containerd config default 
#      cmd: containerd config default > /etc/containerd/config.toml  #there is no redirection man
    register: cmd_result
  # - debug:
  #     msg: "this is the out of cmd_result register: {{ cmd_result }}"
  - name: configure file /etc/containerd/config.toml
    ansible.builtin.blockinfile:
      path: /etc/containerd/config.toml
      block: |
        {{ cmd_result.stdout }}
      create: true      
    when: k8s_prerequists_state.changed == true      
    # notify:
    # - restart containerd  

  # - name: configure containerd config file
  #   ansible.builtin.command:
  #     cmd: sudo sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
  - name: configure containerd config file 
    lineinfile: 
      path: /etc/containerd/config.toml
      regexp: '^            SystemdCgroup = '
      line: '            SystemdCgroup = true'
    when: k8s_prerequists_state.changed == true      
    # notify:
    # - restart containerd  

  - name: removing ansible marker from /etc/containerd/config.toml
    ansible.builtin.lineinfile:
      path: /etc/containerd/config.toml
      state: absent
      regexp: 'ANSIBLE'
    when: k8s_prerequists_state.changed == true

  - name: restart containerd
    systemd:
      name: containerd
      state: restarted      
    when: k8s_prerequists_state.changed == true

  - name: Check if file /etc/apt/keyrings/kubernetes-apt-keyring.gpg exists
    stat:
      path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    register: stat_result
  - debug: msg={{stat_result}}
  - name: Add k8s key
    ansible.builtin.shell: curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    when: not stat_result.stat.exists
  # - name: add k8s repo
  #   ansible.builtin.command:
  #     cmd: echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
  - name: configure file /etc/apt/sources.list.d/kubernetes.list
    ansible.builtin.blockinfile:
      path: /etc/apt/sources.list.d/kubernetes.list
      block: |
        deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /
      create: true

  - name: Check if file /etc/kubernetes/admin.conf exists
    stat:
      path: /etc/kubernetes/admin.conf 
    register: stat_kube_init_result
  - debug: msg={{stat_kube_init_result}}

  - name: update apt repo & cache
    apt:
      update_cache: yes
  - name: Install kubeadm
    ansible.builtin.apt:
      update_cache: yes
      pkg:
        - kubelet=1.28.2-1.1
        - kubeadm=1.28.2-1.1
        - kubectl=1.28.2-1.1
      allow_downgrade: true

  - name: output the register variable value
    debug:
      var:  hostvars['3.14.149.54']['kubeadm_command_output']['stdout']      
  - name: output the register variable value
    debug:
      var:  hostvars['master_instaall_kubeadm']['kubeadm_command_output']['stdout']
  - name: kubeadm join 
    ansible.builtin.command: 
      cmd: "{{ hostvars['3.14.149.54']['kubeadm_command_output']['stdout'] }}"      
    when: k8s_prerequists_state.changed == true                        




  # - name: output the register variable value
  #   debug:
  #     var:  hostvars['13.50.110.214']['kubeadm_command_output']['stdout']
  
  # ansible-inventory --list
